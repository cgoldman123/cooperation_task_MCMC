---
title: "cooperation_task_MCMC_test"
output: html_document
date: "2024-06-17"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}





  # priors ==============================================================

  
  
  # task ==============================================================

    # loop over subjects
"NS" <-
3
"num.forced.choices" <-
3
"num.trials.per.block" <-
16
"num.blocks" <-
30
"all.actions" <-
structure(c(2,2,2,1,1,1,3,3,3,2,2,2,2,2,2,3,3,3,2,2,2,2,2,2,1,1,1,3,3,3,3,3,3,1,1,1,3,3,3,2,2,2,1,1,1,3,3,3,1,1,1,3,3,3,1,1,1,3,3,3,2,2,2,1,1,1,3,3,3,3,3,3,3,3,3,3,3,3,2,2,2,1,1,1,1,1,1,3,3,3,3,3,3,1,1,1,3,3,3,3,3,3,2,2,2,2,2,2,2,2,2,2,2,2,3,3,3,3,3,3,2,2,2,1,1,1,1,1,1,1,1,1,1,1,1,3,3,3,1,1,1,3,3,3,1,1,1,3,3,3,3,3,3,2,2,2,3,3,3,2,2,2,3,3,3,3,3,3,3,3,3,2,2,2,3,3,3,2,2,2,1,1,1,3,3,3,2,2,2,1,1,1,3,3,3,3,3,3,2,2,2,2,2,2,2,2,2,3,3,3,2,2,2,1,1,1,3,3,3,1,1,1,2,2,2,1,1,1,3,3,3,2,2,2,1,1,1,3,3,3,1,1,1,1,1,1,2,2,2,3,3,3,2,2,2,1,1,1,2,2,2,2,2,2,2,2,2,3,3,3,1,1,1,2,2,3,1,2,1,1,1,1,1,1,1,1,1,3,2,3,2,3,1,1,2,3,2,3,1,3,3,1,1,2,2,1,2,2,2,3,3,2,2,2,1,2,2,3,1,3,3,2,1,1,1,2,1,2,1,1,2,1,1,1,3,1,2,1,2,2,1,1,1,1,2,2,2,3,2,1,2,1,2,3,2,2,1,1,2,1,2,1,1,3,2,3,1,1,2,1,1,1,2,1,1,3,1,1,2,3,3,3,3,1,3,1,2,1,2,3,1,3,1,3,2,1,2,2,2,1,2,3,2,3,1,1,2,3,1,2,2,1,1,1,2,3,1,1,2,1,2,1,1,1,3,3,3,1,2,1,1,1,1,3,1,3,2,3,2,3,2,1,3,1,2,3,3,2,3,1,1,2,1,2,1,2,1,1,2,1,1,1,3,1,1,2,1,1,3,1,3,3,1,1,1,1,3,2,2,1,1,1,1,1,2,1,3,2,3,1,2,3,2,3,1,2,2,3,1,1,2,1,1,1,3,2,1,2,2,1,2,1,1,1,1,3,2,1,2,1,1,1,3,2,1,2,1,2,3,3,1,1,3,1,3,1,2,2,1,1,1,3,1,3,1,2,1,1,2,1,1,1,1,2,1,2,1,1,1,1,3,3,1,1,1,2,3,3,2,1,1,2,1,1,3,1,3,3,3,1,2,3,2,3,1,3,2,3,1,2,2,1,1,1,2,3,1,2,2,1,2,1,2,1,2,3,2,1,1,1,1,1,2,1,1,1,3,2,1,2,1,1,1,2,1,1,2,2,1,1,1,1,1,3,1,2,1,1,2,1,3,1,1,3,2,2,2,1,1,1,1,3,1,1,1,2,1,2,3,1,1,2,2,1,2,1,2,1,3,1,2,3,3,1,1,3,2,2,1,2,2,1,1,1,2,1,1,3,1,1,2,2,2,1,3,2,2,1,1,1,1,1,2,1,1,1,2,2,1,2,1,1,3,2,1,1,2,2,1,1,1,2,1,3,3,2,1,2,2,1,2,1,1,2,2,3,1,1,1,1,1,1,1,1,1,1,1,2,3,2,1,2,1,1,2,1,2,1,1,1,1,3,3,2,1,2,2,2,1,2,2,1,1,1,2,1,1,3,3,1,1,1,2,1,1,2,2,2,1,1,1,1,1,1,1,2,1,1,1,2,3,1,2,3,1,1,3,2,3,2,1,1,1,3,3,2,1,3,2,1,2,1,1,1,3,2,1,1,1,1,1,1,1,1,1,1,1,2,1,2,1,3,1,1,1,1,2,1,1,1,2,3,3,3,1,2,2,2,1,2,1,1,1,1,1,2,1,1,1,1,1,3,3,1,1,2,2,3,1,2,1,1,2,1,2,2,3,1,1,1,3,1,1,3,1,1,1,2,3,2,1,1,1,3,3,1,1,2,3,1,2,1,1,1,3,2,2,1,3,1,1,1,1,1,1,1,1,2,1,2,1,3,1,1,1,1,2,2,1,1,1,1,3,3,2,2,2,2,1,1,1,1,1,1,1,1,2,1,2,1,1,2,3,1,1,2,2,2,1,1,1,1,2,2,2,1,3,1,1,1,3,1,1,3,1,1,1,2,2,3,1,1,1,3,1,1,1,1,1,1,2,1,1,3,1,1,3,1,1,1,1,1,1,1,1,2,1,2,1,3,3,2,1,1,1,1,2,1,1,1,1,1,3,3,2,2,2,1,1,2,1,1,1,1,1,1,2,1,2,1,1,2,3,1,1,2,2,1,1,1,1,1,2,2,3,1,3,1,1,1,2,1,1,2,1,1,1,2,1,3,1,2,1,3,2,3,1,1,1,1,1,1,1,2,1,1,1,1,1,1,1,1,3,1,1,3,1,2,1,3,2,2,1,1,2,1,2,2,2,1,1,1,2,3,3,2,2,1,1,1,1,1,1,1,1,1,2,2,2,1,1,1,3,1,1,2,2,1,3,1,1,1,2,1,1,1,2,3,1,1,2,1,1,2,3,1,1,2,1,3,2,1,1,2,2,2,1,1,1,1,2,1,1,1,2,1,1,1,1,1,1,1,2,1,1,1,1,2,3,3,3,1,1,1,1,1,2,1,2,1,1,1,2,2,1,2,2,1,1,2,1,1,1,1,1,1,2,2,2,3,1,2,2,1,1,1,2,2,3,1,1,1,2,1,1,1,1,3,1,1,2,2,1,1,2,1,1,2,1,3,2,3,1,3,2,2,1,1,1,1,3,1,1,1,3,1,1,1,1,1,1,1,1,1,1,1,3,2,1,1,3,2,1,1,1,1,2,3,3,1,1,2,2,2,1,2,2,1,1,2,1,1,3,1,1,1,2,2,2,2,1,1,1,1,2,1,2,2,3,1,1,1,2,2,1,1,1,2,1,1,1,3,1,1,2,1,1,2,1,3,1,1,1,3,2,2,1,1,1,1,2,1,1,2,3,1,1,1,1,1,1,1,1,1,1,1,3,2,3,1,1,3,1,1,2,1,2,2,3,1,3,3,3,2,1,2,1,1,1,1,1,1,2,1,1,1,2,2,2,2,1,1,1,1,1,3,2,2,2,1,1,1,2,2,2,1,1,1,1,3,1,2,1,2,2,1,1,2,1,3), .Dim=c(3,30,16))
"all.observations" <-
structure(c(2,2,2,3,3,3,3,3,3,3,3,3,2,2,2,1,1,1,1,1,1,3,3,3,3,3,3,1,1,1,2,2,2,1,1,1,3,3,3,3,3,3,3,3,3,1,1,1,1,1,1,3,3,3,2,2,2,1,1,1,1,1,1,3,3,3,2,2,2,3,3,3,2,2,2,1,1,1,3,3,3,1,1,1,2,2,2,2,2,2,3,3,3,3,3,3,2,2,2,3,3,3,2,2,2,2,2,2,2,2,2,1,1,1,3,3,3,3,3,3,2,2,2,1,1,1,3,3,3,2,2,2,1,1,1,3,3,3,3,3,3,3,3,3,2,2,2,3,3,3,3,3,3,2,2,2,2,2,2,2,2,2,3,3,3,3,3,3,2,2,2,2,2,2,2,2,2,2,2,2,1,1,1,2,2,2,2,2,2,2,2,2,3,3,3,3,3,3,2,2,2,3,3,3,2,2,2,1,1,1,3,3,3,3,3,3,1,1,1,2,2,2,2,2,2,2,2,2,3,3,3,2,2,2,1,1,1,3,3,3,2,2,2,1,1,1,1,1,1,3,3,3,2,2,2,2,2,2,1,1,1,2,2,2,1,1,1,3,3,3,2,1,1,2,3,1,1,2,3,1,1,1,3,3,2,2,1,3,2,1,2,1,1,3,3,3,2,3,3,3,3,3,1,2,1,1,1,1,2,3,3,2,2,3,1,2,2,2,1,3,3,2,1,1,2,2,1,2,3,3,2,1,1,1,1,3,2,1,2,2,1,1,1,3,2,2,2,3,2,2,2,3,2,3,1,3,3,3,2,1,2,2,1,1,3,3,1,1,1,1,1,1,2,2,1,3,1,1,2,3,2,1,3,1,3,1,2,3,2,3,1,3,3,2,1,1,3,2,2,1,1,3,2,1,1,3,1,3,1,1,2,1,1,2,2,3,1,3,2,1,1,1,1,1,3,1,2,1,2,1,1,1,3,2,1,3,3,2,2,2,2,1,1,1,3,3,3,2,1,1,1,1,1,2,1,3,1,1,2,3,2,1,3,2,2,1,2,1,3,1,3,3,1,3,1,2,3,2,2,3,2,3,3,1,2,1,3,2,3,3,2,1,2,3,1,3,1,3,1,2,3,1,1,1,3,2,2,2,2,1,2,1,3,1,3,3,1,1,3,1,2,3,3,2,3,2,2,2,2,2,2,1,3,3,3,1,2,2,3,1,2,3,1,3,3,1,1,2,1,2,3,2,1,2,2,2,2,2,1,1,3,3,1,1,1,2,3,3,2,3,3,1,1,1,3,1,3,3,2,1,2,3,2,3,3,2,2,3,1,2,1,1,1,1,1,3,1,3,2,1,2,3,2,3,3,3,1,1,1,3,2,1,2,1,1,1,3,2,1,2,2,2,3,1,1,3,2,2,1,2,1,2,1,1,2,2,2,3,1,1,2,2,1,3,2,2,2,1,2,2,1,3,1,1,1,2,1,2,2,3,3,2,3,1,2,3,2,2,3,1,2,1,1,3,2,3,1,2,3,1,2,2,1,1,2,2,1,3,3,3,3,2,2,1,3,2,2,3,2,1,3,1,2,1,3,2,3,2,1,2,3,1,3,3,1,1,2,2,3,2,3,2,1,3,1,2,2,2,2,1,1,1,2,3,2,3,1,1,1,1,2,1,1,3,3,1,1,2,3,2,1,3,1,1,2,3,1,1,2,2,1,3,1,3,1,2,1,2,1,1,2,2,1,2,3,2,1,3,3,1,1,3,2,1,1,1,2,2,1,3,1,1,3,2,3,1,2,1,1,2,3,2,2,3,1,1,3,2,3,2,1,3,3,1,3,2,1,3,3,2,2,1,3,2,2,2,3,2,1,1,1,1,1,1,1,2,1,2,3,2,3,1,3,2,1,1,3,2,1,1,2,3,2,1,3,1,1,2,1,2,1,2,1,2,1,2,2,2,3,3,1,3,3,3,1,1,2,3,1,2,1,1,2,2,2,2,2,1,1,1,3,3,1,1,3,1,1,2,3,2,1,1,1,1,3,2,1,3,3,1,1,1,1,3,3,3,3,3,3,2,1,2,3,1,1,2,3,2,1,2,3,3,1,3,1,1,1,1,3,3,1,1,2,2,2,2,2,3,1,1,1,1,1,1,2,1,1,1,3,1,1,2,2,1,1,1,2,2,3,2,1,3,1,1,2,1,3,3,3,1,2,3,1,3,3,3,1,2,2,3,1,2,1,3,2,1,1,1,1,1,2,1,1,2,1,1,3,1,2,1,2,1,3,1,2,2,1,2,1,1,1,3,1,3,3,1,1,2,3,1,1,3,3,2,2,2,1,3,1,2,1,1,2,1,1,1,1,3,1,1,2,3,2,1,1,2,2,3,3,1,1,1,3,2,3,1,3,2,1,1,1,3,1,2,3,2,1,1,1,1,2,2,2,3,2,3,1,2,1,3,2,2,3,3,2,1,2,1,1,1,1,3,3,1,1,2,2,1,3,2,2,2,1,3,2,1,2,2,1,1,1,1,1,3,2,3,2,1,1,3,1,1,1,1,2,1,2,1,2,3,2,1,3,3,1,2,2,3,3,1,1,1,2,3,2,1,2,2,1,3,2,3,1,2,3,1,1,2,1,1,2,2,1,2,2,1,1,1,2,1,2,1,1,1,3,2,1,1,2,1,2,1,3,3,1,3,3,1,1,3,3,1,3,1,3,1,2,3,3,3,1,3,2,2,1,2,2,1,1,2,1,2,3,1,1,2,2,2,3,2,3,2,3,3,1,3,2,1,1,3,1,1,2,3,1,1,2,3,3,2,2,2,3,2,2,3,1,2,2,3,2,3,3,3,2,1,2,1,2,1,3,1,1,2,3,1,1,1,2,1,2,1,1,1,2,1,2,2,3,1,3,2,3,1,3,2,2,3,1,1,3,2,3,2,1,1,2,3,3,2,3,1,2,1,1,1,1,2,2,3,3,1,3,1,2,3,3,1,3,1,3,1,2,3,3,2,3,2,3,3,3,3,3,3,2,3,3,2,1,1,1,3,1,3,2,2,1,1,3,2,1,1,3,2,2,1,3,2,1,2,1,2,3,1,1,1,3,3,3,1,1,3,2,3,3,3,2,2,1,1,3,1,2,2,3,2,3,1,1,1,3,1,1,1,3,1,1,2,2,2,3,2,3,3,1,3,2,1,2,1,1,2,2,2,2,1,2,1,1,2,1,2,3,2,3,2,3,3,1,1), .Dim=c(3,30,16))

a = array(NA, dim=c(3,30,16,3,3))
A = array(NA, dim=c(3,30,16,3,3))
a.sums = array(NA, dim=c(3,30,16,3,3))
info.gain = array(NA, dim=c(3,30,16,3,3))
count.to.add = array(NA, dim=c(3,30,16,3,3))
counts.remembered = array(NA, dim=c(3,30,16,3,3))
epistemic.value = array(NA, dim=c(3,30,16,3))
G = array(NA, dim=c(3,30,16,3))
pragmatic.value = array(NA, dim=c(3,30,16,3))
q = array(NA, dim=c(3,30,16,3))
transformed.q = array(NA, dim=c(3,30,16,3))
action.probs = array(NA, dim=c(3,30,16,3))
C = array(NA,dim=c(3,3))
softmaxed.C = array(NA,dim=c(3,3))




s = 1

pa = .25
eta = .5
cr = 4
cl = 4
alpha = 4
omega = .25

C[s,1] <- cr[s]
C[s,2] <- 0
C[s,3] <- -cl[s]
softmaxed.C[s,1] = exp(C[s,1])/(exp(C[s,1]) + exp(C[s,2]) + exp(C[s,3]))
softmaxed.C[s,2] = exp(C[s,2])/(exp(C[s,1]) + exp(C[s,2]) + exp(C[s,3]))
softmaxed.C[s,3] = exp(C[s,3])/(exp(C[s,1]) + exp(C[s,2]) + exp(C[s,3]))


for (b in 1:num.blocks) {
  for (pol in 1:3) {
        for (k in 1:3) {
            a[s,b,1,k,pol] = pa[s]
        }
  }

  for (t in 2:num.trials.per.block) {
     for (pol in 1:3) {
        for (k in 1:3) {
            count.to.add[s,b,t,k,pol] <- ifelse((k == all.observations[s,b,t-1]) && (pol == all.actions[s,b,t-1]),eta[s],0)
            counts.remembered[s,b,t,k,pol] <- (a[s,b,t-1,k,pol] - pa[s])*(1-omega[s]) + pa
            a[s,b,t,k,pol] <- counts.remembered[s,b,t,k,pol] + count.to.add[s,b,t,k,pol]
        }
     }
   }

   for (t in 4:num.trials.per.block) {
      for (pol in 1:3) {
           for (k in 1:3) {
               A[s,b,t,k,pol] <- a[s,b,t,k,pol]/(a[s,b,t,1,pol] + a[s,b,t,2,pol] + a[s,b,t,3,pol])
               a.sums[s,b,t,k,pol] = (a[s,b,t,1,pol] + a[s,b,t,2,pol] + a[s,b,t,3,pol])
               info.gain[s,b,t,k,pol] = .5*((a[s,b,t,k,pol]^-1)-(a.sums[s,b,t,k,pol]^-1))
           }
           epistemic.value[s,b,t,pol] <- sum(A[s,b,t,,pol] * info.gain[s,b,t,,pol])
           pragmatic.value[s,b,t,pol] <- sum(A[s,b,t,,pol] * log(softmaxed.C[s,]))
           G[s,b,t,pol] <- -epistemic.value[s,b,t,pol] - pragmatic.value[s,b,t,pol]
      }
      for (pol in 1:3){
           q[s,b,t,pol] <- (exp(-G[s,b,t,pol])) / (exp(-G[s,b,t,1]) + exp(-G[s,b,t,2]) + exp(-G[s,b,t,3]))
           transformed.q[s,b,t,pol] <- alpha[s] * log(q[s,b,t,pol])
      }
      for (pol in 1:3) {
           action.probs[s,b,t,pol] <- ifelse((transformed.q[s,b,t,1] + transformed.q[s,b,t,2] + transformed.q[s,b,t,3]) == 0, 1/3, exp(transformed.q[s,b,t,pol]) / (exp(transformed.q[s,b,t,1]) + exp(transformed.q[s,b,t,2]) + exp(transformed.q[s,b,t,3])))
      }
     # all.actions[s, b, t] ~ dcat(action.probs[s,b,t,])

   }
}

    

```

